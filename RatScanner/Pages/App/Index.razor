@page "/"
@page "/app"
@using RatScanner.Scan
@using RatScanner.TarkovDev.GraphQL
@using RatScanner.Pages.App.Components
@using RatScanner.Pages.InteractableOverlay.Services
@using System.Diagnostics
@using SearchResult = RatScanner.Pages.InteractableOverlay.Services.SearchResult
@inject MenuVM MenuVM
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IDisposable

<div>
    <!-- Header Bar -->
    <div class="header-bar" @onmousedown="StartDrag" @onmousedown:stopPropagation="false">
        <div class="header-left">
            <MudIconButton Icon="@Icons.Material.Filled.Settings"
                           Size="Size.Small"
                           Class="header-button"
                           Href="/app/settings/general"
                           @onmousedown:stopPropagation="true" />
            <MudDivider Vertical="true" FlexItem="true" />
            <img src="RatLogoMedium.png" width="20" class="header-logo" />
            <MudText Typo="Typo.subtitle1" Class="header-title">RatScanner</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">v@(RatConfig.Version)</MudText>
        </div>
        <div class="header-right" @onmousedown:stopPropagation="true">
            <MudIconButton Icon="@Icons.Material.Filled.Minimize" 
                          Size="Size.Small" 
                          Class="header-button"
                          OnClick="MinimizeWindow" />
            <MudIconButton Icon="@Icons.Material.Filled.ZoomInMap"
                          Size="Size.Small" 
                          Class="header-button"
                          OnClick="ShowMinimalUI"
                          Title="Minimal UI" />
            <MudIconButton Icon="@Icons.Material.Filled.Close" 
                          Size="Size.Small" 
                          Class="header-button header-button-close"
                          OnClick="CloseWindow" />
        </div>
    </div>

    <!-- Main Content -->
    <MudStack Spacing="2" Class="pa-2 main-content">
        <!-- Search Box -->
        <MudPaper Class="pa-2" Elevation="2">
            <MudTextField @ref="_searchTextField" T="string" 
                          Variant="Variant.Outlined"
                          Placeholder="Search items..."
                          Adornment="Adornment.End" 
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          DebounceInterval="100" 
                          OnDebounceIntervalElapsed="ExecuteSearch" 
                          @bind-Value="@_searchText"
                          Margin="Margin.Dense" />
        </MudPaper>

        @if (_searchResults.Any()) {
            <!-- Search Results -->
            @foreach (SearchResult searchResult in _searchResults.Take(3)) {
                @if (searchResult.Data is Item item) {
                    <CompactItemResult Item="@item" />
                }
            }

            <!-- Clear search button -->
            <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="ClearSearch" 
                       StartIcon="@Icons.Material.Filled.Clear">
                Clear Search
            </MudButton>
        } else {
            <!-- Last Scanned Item -->
            @if (MenuVM.LastItem != null) {
                <CompactItemResult Item="@MenuVM.LastItem" />
            }

            <!-- Quick Stats -->
            <MudPaper Class="pa-2" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceAround">
                    <MudStack Spacing="0" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.h6" Color="@(MenuVM.TaskRemaining > 0 ? Color.Success : Color.Default)">
                            @MenuVM.TaskRemaining
                        </MudText>
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Checklist" Size="Size.Small" />
                            <MudText Typo="Typo.caption">Quests</MudText>
                        </MudStack>
                    </MudStack>

                    <MudDivider Vertical="true" FlexItem="true" />

                    <MudStack Spacing="0" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.h6" Color="@(MenuVM.HideoutRemaining > 0 ? Color.Success : Color.Default)">
                            @MenuVM.HideoutRemaining
                        </MudText>
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.House" Size="Size.Small" />
                            <MudText Typo="Typo.caption">Hideout</MudText>
                        </MudStack>
                    </MudStack>

                    @if (MenuVM.ShowKappaNeeds == true) {
                        <MudDivider Vertical="true" FlexItem="true" />

                        <MudStack Spacing="0" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.h6" Color="@(MenuVM.TaskRemainingKappa > 0 ? Color.Warning : Color.Default)">
                                @MenuVM.TaskRemainingKappa
                            </MudText>
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Size="Size.Small" />
                                <MudText Typo="Typo.caption">Kappa</MudText>
                            </MudStack>
                        </MudStack>
                    }
                </MudStack>
            </MudPaper>

            <!-- Team Needs (if any) -->
            @if (MenuVM.ItemTeamNeeds != null && MenuVM.ItemTeamNeeds.Any()) {
                <MudPaper Class="pa-2" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">Team Needs</MudText>
                    @foreach (var need in MenuVM.ItemTeamNeeds) {
                        <MudStack Row="true" Justify="Justify.SpaceBetween" Class="py-1">
                            <MudText Typo="Typo.body2">@need.Key</MudText>
                            <MudStack Row="true" Spacing="2">
                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                    <MudIcon Icon="@Icons.Material.Filled.Checklist" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">@need.Value.Key</MudText>
                                </MudStack>
                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                    <MudIcon Icon="@Icons.Material.Filled.House" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">@need.Value.Value</MudText>
                                </MudStack>
                            </MudStack>
                        </MudStack>
                    }
                </MudPaper>
            }

            <!-- Quick Links for current item -->
            <MudStack Row="true" Spacing="2">
                <MudPaper Class="flex-1 pa-2 d-flex align-center justify-center" Elevation="2" 
                          Style="cursor: pointer;" @onclick="OpenWiki">
                    <img src="https://static.wikia.nocookie.net/escapefromtarkov_gamepedia/images/e/e6/Site-logo.png" height="20px" />
                </MudPaper>
                <MudPaper Class="flex-1 pa-2 d-flex align-center justify-center" Elevation="2" 
                          Style="cursor: pointer;" @onclick="OpenTarkovDev">
                    <img src="https://api.ratscanner.com/v3/file/tarkov-dev-logo.png" height="16px" />
                </MudPaper>
            </MudStack>
        }
    </MudStack>

    <!-- Resize Grip -->
    <div class="resize-grip" 
         @onmousedown="StartResize" 
         @onmousedown:preventDefault="true"
         @onmousedown:stopPropagation="false">
        <svg>
            <path d="M9 0 L11 0 L11 2 L9 2 Z M6 3 L8 3 L8 5 L6 5 Z M9 3 L11 3 L11 5 L9 5 Z M3 6 L5 6 L5 8 L3 8 Z M6 6 L8 6 L8 8 L6 8 Z M9 6 L11 6 L11 8 L9 8 Z M0 9 L2 9 L2 11 L0 11 Z M3 9 L5 9 L5 11 L3 11 Z M6 9 L8 9 L8 11 L6 11 Z M9 9 L11 9 L9 11 Z" fill="#DDDDDD" />
        </svg>
    </div>
</div>

<style>
    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 8px;
        background: #1e1e1e;
        border-bottom: 2px solid rgba(255, 255, 255, 0.12);
        cursor: move;
        user-select: none;
        -webkit-app-region: drag;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .header-logo {
        vertical-align: middle;
    }

    .header-title {
        margin: 0;
        line-height: 1;
    }

    .header-right {
        display: flex;
        gap: 2px;
        -webkit-app-region: no-drag;
    }

    .header-button {
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .header-button:hover {
        opacity: 1;
    }

    .header-button-close:hover {
        color: #ff4444;
    }

    .main-content {
        flex: 1;
        overflow-y: auto;
    }

    .resize-grip {
        position: absolute;
        overflow: hidden;
        bottom: 2px;
        right: 2px;
        width: 11px;
        height: 11px;
        cursor: nwse-resize;
        z-index: 100;
    }

    .resize-grip:hover svg path {
        fill: #aaaaaa;
    }

    .ellipsis {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>

@code {
    private MudTextField<string> _searchTextField = null!;
    private string _searchText = "";
    private IEnumerable<SearchResult> _searchResults = new List<SearchResult>();
    private readonly SearchService _searchService = new();

    protected override void OnInitialized() {
        MenuVM.PropertyChanged += PropertyChangeHandler;
    }

    private void StartDrag(MouseEventArgs e) {
        PageSwitcher.Instance.StartDrag();
    }

    private void StartResize(MouseEventArgs e) {
        if (e.Button != 0) return;
        PageSwitcher.Instance.StartResize();
    }

    private void ShowMinimalUI() {
        PageSwitcher.Instance.ShowMinimalUI();
    }

    private void MinimizeWindow() {
        PageSwitcher.Instance.MinimizeWindow();
    }

    private void CloseWindow() {
        PageSwitcher.Instance.Close();
    }

    private async void ExecuteSearch(string value) {
        if (string.IsNullOrWhiteSpace(value)) {
            _searchResults = new List<SearchResult>();
            await InvokeAsync(StateHasChanged);
            return;
        }

        var sanitizedValue = _searchService.SanitizeSearch(value);
        var results = Enumerable.Empty<SearchResult>();
        results = results.Concat(await _searchService.SearchItemsAsync(sanitizedValue));
        results = results.Where(result => result != null && result.Data != null);
        results = results.OrderBy(result => result.Score).Take(3);
        _searchResults = results;
        await InvokeAsync(StateHasChanged);
    }

    private void ClearSearch() {
        _searchText = "";
        _searchResults = new List<SearchResult>();
    }

    private void OpenWiki() {
        OpenURL(MenuVM.LastItem?.WikiLink);
    }

    private void OpenTarkovDev() {
        OpenURL(MenuVM.LastItem?.Link);
    }

    private void OpenURL(string? url) {
        if (string.IsNullOrEmpty(url)) return;
        var psi = new ProcessStartInfo {
            FileName = url,
            UseShellExecute = true,
        };
        Process.Start(psi);
    }

    private async void PropertyChangeHandler(object? sender, EventArgs e) {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose() {
        MenuVM.PropertyChanged -= PropertyChangeHandler;
    }
}
